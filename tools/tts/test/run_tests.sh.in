#!/bin/sh

# Run normaliser tests

giella_core=@GIELLA_CORE@
glang=@GLANG@
tool_dir=$(pwd)/..
script_dir=${tool_dir}/modes

test_file=$1
innput=$(basename $test_file .txt).in
output=$(basename $test_file .txt).out
expect=$(basename $test_file .txt).expect

if [[ $test_file =~ \.ipa\.txt$ ]]; then
    IPA=yes
fi

cut -d"#" -f1 $test_file | grep -v "^$" | head -n 1 > $innput
cut -d"#" -f1 $test_file | grep -v "^$" | tail -n +2 | cut -f1-2 | grep -v "^:" > $expect

# Replace use of mode files with zpipe file when libdivvun is working.
# The mode files require a manual run of `cd tools/tts/ && make dev` before
# working, and that's no good for `make check`
if [ -n "$IPA" ]; then
    testscript=${glang}-txt2ipa.mode
else
    testscript=${glang}-normaliser.mode
fi
"${script_dir}/${testscript}" < $innput \
 | $giella_core/scripts/vislcg-convert.py -t phon -1 \
 | grep -v "^:" \
 | grep -v "^$" \
 | cut -f1-2 \
 > $output

diff $output $expect
